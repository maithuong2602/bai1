<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách Buổi học & Ghi chú</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f7f9; }
        .listbox {
            border: 2px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .list-header {
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        ul {
            list-style: none;
            padding: 0;
        }
        li {
            padding: 8px 0;
            cursor: pointer;
            color: #007bff;
            text-decoration: underline;
            transition: color 0.2s;
        }
        li:hover {
            color: #0056b3;
            text-decoration: none;
        }
        .add-button {
            margin-top: 10px;
            padding: 8px 15px;
            cursor: pointer;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .add-button:hover {
            background-color: #1e7e34;
        }
        .control-buttons button {
            padding: 10px 15px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .control-buttons button:hover {
            opacity: 0.9;
        }
        .export-btn { background-color: #007bff; color: white; }
        .import-btn { background-color: #ffc107; color: #212529; }
        .clear-btn { background-color: #dc3545; color: white; }

        /* Style riêng cho Listbox mới */
        #ghiChuChungBox {
            border-color: #6f42c1;
        }
        #ghiChuChungBox .list-header {
            color: #6f42c1;
            border-bottom-color: #6f42c1;
        }
    </style>
</head>
<body>

    <div class="control-buttons" style="margin-bottom: 20px;">
        <button class="export-btn" onclick="xuatJSON()">Xuất Dữ Liệu (JSON)</button>
        <input type="file" id="importFile" accept="application/json" style="display: none;" onchange="nhapJSON(event)">
        <button class="import-btn" onclick="document.getElementById('importFile').click()">Nhập Dữ Liệu (JSON)</button>
        <button class="clear-btn" onclick="clearLocalStorage()">Xóa Dữ Liệu Cục Bộ</button>
    </div>

    <h1>Danh Sách Các Buổi</h1>

    <!-- 
        Container cho các buổi từ 1 đến 20. 
        Trong ví dụ này chỉ tạo Buổi 1 và Buổi 2, nhưng JS đã hỗ trợ 20 buổi.
    -->
    <div id="container-listboxes">
        
        <div class="listbox">
            <div class="list-header">Buổi 1</div>
            <ul id="buoi1">
                <!-- Nội dung được tải từ JS -->
            </ul>
            <button class="add-button" onclick="themNoiDung('buoi1')">Thêm Nội Dung</button>
        </div>

        <div class="listbox">
            <div class="list-header">Buổi 2</div>
            <ul id="buoi2"></ul>
            <button class="add-button" onclick="themNoiDung('buoi2')">Thêm Nội Dung</button>
        </div>
        
        <!-- ... Các buổi 3 đến 20 sẽ theo mẫu trên ... -->
    </div>


    <!-- 
        LISTBOX MỚI ĐƯỢC BỔ SUNG Ở ĐÂY
        ID của UL là 'ghiChuChung'
    -->
    <div class="listbox" id="ghiChuChungBox">
        <div class="list-header">Ghi Chú Chung (Ngoài Các Buổi)</div>
        <ul id="ghiChuChung"></ul>
        <button class="add-button" onclick="themNoiDung('ghiChuChung')">Thêm Ghi Chú</button>
    </div>


    <script>
        // Key dùng để lưu trữ dữ liệu trong LocalStorage
        const LOCAL_STORAGE_KEY = 'buoiDataWithNotes';

        // Cấu trúc dữ liệu sẽ là một đối tượng: { 'buoi1': [...], 'buoi2': [...], ..., 'ghiChuChung': [...] }
        let appData = {}; 
        
        // Danh sách ID các listbox cần khởi tạo
        const LISTBOX_IDS = [];
        for (let i = 1; i <= 20; i++) {
            LISTBOX_IDS.push(`buoi${i}`);
        }
        LISTBOX_IDS.push('ghiChuChung'); // Thêm ID mới

        // Hàm khởi tạo/tải dữ liệu khi trang được load
        function loadData() {
            const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedData) {
                appData = JSON.parse(storedData);
            } 
            
            // Đảm bảo tất cả các ID (kể cả ID mới) đều có trong appData
            LISTBOX_IDS.forEach(id => {
                if (!appData[id]) {
                    appData[id] = [];
                }
            });
            
            renderAllListboxes();
        }

        // Hàm lưu dữ liệu vào LocalStorage
        function saveData() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appData));
        }
        
        // Hàm vẽ lại toàn bộ nội dung dựa trên dữ liệu 'appData'
        function renderAllListboxes() {
            for (const listId of LISTBOX_IDS) {
                const ulElement = document.getElementById(listId);
                
                if (ulElement) {
                    ulElement.innerHTML = ''; // Xóa nội dung cũ
                    
                    appData[listId].forEach(item => {
                        const listItem = createListItem(item.title, item.id);
                        ulElement.appendChild(listItem);
                    });
                } else {
                    // console.error(`Element with ID ${listId} not found in DOM.`);
                }
            }
        }

        // Hàm tạo phần tử <li> với sự kiện click
        function createListItem(title, id) {
            const listItem = document.createElement('li');
            listItem.textContent = title;
            
            listItem.onclick = function() {
                // Chuyển hướng đến trang chi tiết
                window.location.href = `detail.html?id=${id}&title=${encodeURIComponent(title)}`;
            };
            return listItem;
        }

        // 1. CHỨC NĂNG THÊM NỘI DUNG
        function themNoiDung(listId) {
            const listTitle = document.querySelector(`#${listId}`).previousElementSibling.textContent;
            const noiDung = prompt(`Nhập nội dung cho Listbox "${listTitle}":`);

            if (noiDung) {
                const newPageId = Date.now(); 
                
                // 1.1. Thêm vào mảng dữ liệu
                const newItem = {
                    id: newPageId,
                    title: noiDung
                };
                
                // Kiểm tra xem listId có hợp lệ và tồn tại trong appData không
                if (appData[listId]) {
                    appData[listId].push(newItem);
                    
                    // 1.2. Lưu dữ liệu
                    saveData(); 
                    
                    // 1.3. Cập nhật giao diện (chỉ cần thêm 1 mục)
                    const listItem = createListItem(noiDung, newPageId);
                    document.getElementById(listId).appendChild(listItem);
                } else {
                    console.error(`List ID ${listId} không tồn tại trong cấu trúc dữ liệu.`);
                }
            }
        }

        // 2. CHỨC NĂNG XUẤT JSON (Export)
        function xuatJSON() {
            const dataStr = JSON.stringify(appData, null, 2); 
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'buoi_data_export.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 3. CHỨC NĂNG NHẬP JSON (Import)
        function nhapJSON(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Cập nhật dữ liệu ứng dụng
                    appData = importedData;
                    
                    // Lưu vào LocalStorage
                    saveData();
                    
                    // Cập nhật giao diện
                    renderAllListboxes();
                    alert('Nhập dữ liệu thành công!');
                } catch (error) {
                    alert('Lỗi khi đọc file JSON: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        // 4. CHỨC NĂNG XÓA LOCAL STORAGE
        function clearLocalStorage() {
            if (confirm('Bạn có chắc chắn muốn xóa toàn bộ dữ liệu cục bộ không? Hành động này không thể hoàn tác!')) {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                // Reset cấu trúc appData
                appData = {};
                LISTBOX_IDS.forEach(id => { appData[id] = []; });
                saveData(); 
                renderAllListboxes();
            }
        }

        // Gọi hàm loadData khi trang được tải xong
        window.onload = loadData; 
        
    </script>

</body>
</html>
