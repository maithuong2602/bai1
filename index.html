<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách Buổi học & Ghi chú (Dynamic)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f7f9; }
        .listbox {
            border: 2px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .list-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .list-header {
            font-size: 1.2em;
            font-weight: 700;
            color: #333;
        }
        .listbox-actions button {
            margin-left: 5px;
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }
        .listbox-edit-btn { background-color: #007bff; color: white; }
        .listbox-delete-btn { background-color: #dc3545; color: white; }
        
        ul {
            list-style: none;
            padding: 0;
        }
        /* Cấu trúc cho mỗi mục nội dung */
        .item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dotted #eee;
        }
        .item-row:last-child {
            border-bottom: none;
        }
        .item-title {
            flex-grow: 1;
            cursor: pointer;
            color: #007bff;
            text-decoration: underline;
            transition: color 0.2s;
            margin-right: 10px;
        }
        .item-title:hover {
            color: #0056b3;
            text-decoration: none;
        }
        .item-actions button {
            margin-left: 5px;
            padding: 3px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85em;
        }
        .edit-btn { background-color: #ffc107; color: #212529; }
        .delete-btn { background-color: #dc3545; color: white; }

        .add-button, .add-listbox-btn {
            margin-top: 10px;
            padding: 8px 15px;
            cursor: pointer;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .add-listbox-btn {
            background-color: #3f51b5;
        }
        .add-button:hover { background-color: #1e7e34; }
        .add-listbox-btn:hover { background-color: #303f9f; }

        .control-buttons button {
            padding: 10px 15px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .control-buttons button:hover { opacity: 0.9; }
        .export-btn { background-color: #007bff; color: white; }
        .import-btn { background-color: #ffc107; color: #212529; }
        .clear-btn { background-color: #dc3545; color: white; }

        /* Style riêng cho Listbox Ghi Chú Chung */
        #ghiChuChung .list-header { color: #6f42c1; }
        
        /* CẬP NHẬT: Chia Listbox thành 2 cột */
        #dynamic-listboxes-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr); 
            gap: 20px; 
            margin-top: 20px;
        }

        /* Responsive: Chuyển về 1 cột trên màn hình nhỏ */
        @media (max-width: 768px) {
            #dynamic-listboxes-container {
                grid-template-columns: 1fr; 
                gap: 15px;
            }
        }
    </style>
</head>
<body>

    <div class="control-buttons" style="margin-bottom: 20px;">
        <button class="export-btn" onclick="xuatJSON()">Xuất Dữ Liệu (JSON)</button>
        <input type="file" id="importFile" accept="application/json" style="display: none;" onchange="nhapJSON(event)">
        <button class="import-btn" onclick="document.getElementById('importFile').click()">Nhập Dữ Liệu (JSON)</button>
        <button class="clear-btn" onclick="clearLocalStorage()">Xóa Dữ Liệu Cục Bộ</button>
    </div>

    <h1>Danh Sách Quản Lý Nội Dung</h1>
    
    <!-- Nút thêm Listbox mới -->
    <button class="add-listbox-btn" onclick="themListBox()">+ Tạo Listbox Mới (Buổi/Ghi Chú)</button>

    <!-- CONTAINER SẼ CHỨA TẤT CẢ CÁC LISTBOX ĐƯỢC TẠO ĐỘNG BẰNG JAVASCRIPT -->
    <div id="dynamic-listboxes-container" style="margin-top: 20px;">
        <!-- Nội dung sẽ được chèn vào đây bởi hàm renderListboxes() -->
    </div>


    <script>
        // Key dùng để lưu trữ dữ liệu trong LocalStorage
        const LOCAL_STORAGE_KEY = 'dynamicListBoxData';

        /* Cấu trúc dữ liệu:
        appData = {
            'listboxId1': { 
                title: 'Tên hiển thị', 
                items: [{ id: 123, title: 'Nội dung', slug: 'url-friendly-name' }] 
            },
            'listboxId2': { ... }
        }
        */
        let appData = {}; 
        
        // Hàm chuyển đổi văn bản sang định dạng slug (URL thân thiện)
        function convertToSlug(text) {
            if (!text) return '';
            // 1. Chuyển tiếng Việt có dấu thành không dấu
            text = text.normalize('NFD').replace(/[\u0300-\u036f]/g, ""); 
            // 2. Loại bỏ ký tự đặc biệt, giữ lại chữ cái, số và khoảng trắng
            text = text.toLowerCase().replace(/[^a-z0-9\s]/g, ""); 
            // 3. Thay thế khoảng trắng bằng dấu gạch ngang
            text = text.replace(/\s+/g, '-'); 
            // 4. Loại bỏ dấu gạch ngang thừa ở đầu/cuối
            return text.replace(/^-+|-+$/g, ''); 
        }

        // Hàm khởi tạo/tải dữ liệu khi trang được load
        function loadData() {
            const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedData) {
                appData = JSON.parse(storedData);
            } else {
                // Chỉ khởi tạo Listbox mặc định: Ghi Chú Chung
                appData = {
                    ghiChuChung: { title: "Ghi Chú Chung (Ngoài Các Buổi)", items: [] }
                };
            }
            renderAllListboxes();
        }

        // Hàm lưu dữ liệu vào LocalStorage
        function saveData() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appData));
        }

        // === QUẢN LÝ LISTBOX (TẠO MỚI, SỬA, XÓA) ===

        // 1. TẠO LISTBOX MỚI
        function themListBox() {
            const newTitle = prompt("Nhập tên cho Listbox mới (ví dụ: Buổi 1, Buổi 2, Ghi chú Khác):");
            if (newTitle) {
                const newId = 'listbox_' + Date.now(); // Tạo ID duy nhất
                appData[newId] = {
                    title: newTitle.trim(),
                    items: []
                };
                saveData();
                
                // Cập nhật DOM bằng cách thêm Listbox mới
                const listbox = appData[newId];
                const listboxElement = createListBoxElement(newId, listbox.title, listbox.items);
                document.getElementById('dynamic-listboxes-container').appendChild(listboxElement);
            }
        }

        // 2. SỬA TÊN LISTBOX
        function suaTenListBox(listId) {
            const currentTitle = appData[listId].title;
            const newTitle = prompt(`Sửa tên cho Listbox "${currentTitle}":`, currentTitle);
            
            if (newTitle && newTitle.trim() !== currentTitle) {
                appData[listId].title = newTitle.trim();
                saveData();
                
                // Cập nhật DOM trực tiếp 
                document.querySelector(`#${listId} .list-header`).textContent = newTitle.trim();
            }
        }

        // 3. XÓA LISTBOX
        function xoaListBox(listId) {
            const title = appData[listId].title;
            if (confirm(`Bạn có chắc chắn muốn xóa Listbox "${title}" và TẤT CẢ nội dung bên trong không?`)) {
                delete appData[listId];
                saveData();
                
                // Xóa phần tử Listbox khỏi DOM
                const listboxElement = document.getElementById(listId);
                if (listboxElement) listboxElement.remove();
            }
        }

        // === RENDER GIAO DIỆN CHÍNH ===

        // Hàm vẽ lại toàn bộ Listbox
        function renderAllListboxes() {
            const container = document.getElementById('dynamic-listboxes-container');
            container.innerHTML = ''; // Xóa nội dung cũ
            
            // Lặp qua tất cả các Listbox trong appData
            for (const listId in appData) {
                if (appData.hasOwnProperty(listId)) {
                    const listbox = appData[listId];
                    const listboxElement = createListBoxElement(listId, listbox.title, listbox.items);
                    container.appendChild(listboxElement);
                }
            }
        }

        // Hàm tạo phần tử div Listbox hoàn chỉnh
        function createListBoxElement(listId, title, items) {
            const listboxDiv = document.createElement('div');
            listboxDiv.className = 'listbox';
            listboxDiv.id = listId;

            // 1. Header (Tên Listbox và nút Sửa/Xóa)
            const headerRow = document.createElement('div');
            headerRow.className = 'list-header-row';
            
            const headerTitle = document.createElement('div');
            headerTitle.className = 'list-header';
            headerTitle.textContent = title;
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'listbox-actions';
            
            const editBtn = document.createElement('button');
            editBtn.className = 'listbox-edit-btn';
            editBtn.textContent = 'Sửa Tên';
            editBtn.onclick = () => suaTenListBox(listId);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'listbox-delete-btn';
            deleteBtn.textContent = 'Xóa Listbox';
            deleteBtn.onclick = () => xoaListBox(listId);

            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(deleteBtn);
            headerRow.appendChild(headerTitle);
            headerRow.appendChild(actionsDiv);
            
            listboxDiv.appendChild(headerRow);

            // 2. Danh sách Nội dung (UL)
            const ulElement = document.createElement('ul');
            items.forEach(item => {
                // Truyền slug vào hàm tạo item
                const itemSlug = item.slug || convertToSlug(item.title);
                ulElement.appendChild(createListItem(item.title, item.id, listId, itemSlug));
            });
            listboxDiv.appendChild(ulElement);

            // 3. Nút Thêm Nội dung
            const addButton = document.createElement('button');
            addButton.className = 'add-button';
            addButton.textContent = 'Thêm Nội Dung';
            addButton.onclick = () => themNoiDung(listId);
            listboxDiv.appendChild(addButton);
            
            return listboxDiv;
        }

        /**
         * Hàm tạo phần tử li cho nội dung.
         * @param {string} title - Tiêu đề nội dung.
         * @param {number} id - ID nội dung (timestamp).
         * @param {string} listId - ID của Listbox chứa mục này.
         * @param {string} slug - Tên file/URL chuẩn hóa.
         */
        function createListItem(title, id, listId, slug) {
            const listItem = document.createElement('li');
            listItem.className = 'item-row';
            listItem.dataset.id = id;

            // 1. Phần tiêu đề (Click để chuyển trang)
            const titleSpan = document.createElement('span');
            titleSpan.className = 'item-title';
            titleSpan.textContent = title;
            titleSpan.onclick = function() {
                // CHỈNH SỬA: Sử dụng slug làm tham số page
                // Ví dụ: detail.html?page=chiahetcho3&id=...
                window.location.href = `detail.html?page=${encodeURIComponent(slug)}&id=${id}&title=${encodeURIComponent(title)}`;
            };
            
            // 2. Phần hành động (Sửa/Xóa nội dung)
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'item-actions';

            const editButton = document.createElement('button');
            editButton.className = 'edit-btn';
            editButton.textContent = 'Sửa';
            editButton.onclick = function(event) {
                event.stopPropagation(); // Ngăn chặn sự kiện click lan truyền lên titleSpan (link)
                suaNoiDung(listId, id);
            };

            const deleteButton = document.createElement('button');
            deleteButton.className = 'delete-btn';
            deleteButton.textContent = 'Xóa';
            deleteButton.onclick = function(event) {
                event.stopPropagation(); // Ngăn chặn sự kiện click lan truyền lên titleSpan (link)
                xoaNoiDung(listId, id);
            };

            actionsDiv.appendChild(editButton);
            actionsDiv.appendChild(deleteButton);
            
            listItem.appendChild(titleSpan);
            listItem.appendChild(actionsDiv);

            return listItem;
        }
        
        // === QUẢN LÝ NỘI DUNG (THÊM, SỬA, XÓA) ===

        // Thêm Nội Dung
        function themNoiDung(listId) {
            const listTitle = appData[listId].title;
            const noiDung = prompt(`Nhập nội dung cho Listbox "${listTitle}":`);

            if (noiDung) {
                const newPageId = Date.now(); 
                const slug = convertToSlug(noiDung); // TẠO SLUG MỚI
                
                const newItem = {
                    id: newPageId,
                    title: noiDung,
                    slug: slug // LƯU SLUG VÀO DỮ LIỆU
                };
                
                appData[listId].items.push(newItem);
                saveData(); 
                    
                const listItem = createListItem(noiDung, newPageId, listId, slug); // Truyền slug vào
                document.querySelector(`#${listId} ul`).appendChild(listItem);
            }
        }

        // Sửa Nội Dung
        function suaNoiDung(listId, itemId) {
            const listTitle = appData[listId].title;
            
            let currentItem = appData[listId].items.find(item => item.id == itemId);
            if (!currentItem) return;

            const newTitle = prompt(`Sửa nội dung cho Listbox "${listTitle}" (Cũ: ${currentItem.title}):`, currentItem.title);

            if (newTitle !== null && newTitle.trim() !== currentItem.title) {
                currentItem.title = newTitle.trim();
                // CHÚ Ý: Không tự động cập nhật slug khi sửa tên để tránh làm hỏng các link đã lưu.
                // Nếu muốn cập nhật slug, người dùng cần xóa và tạo lại.
                saveData(); 
                
                const listItemElement = document.querySelector(`#${listId} li[data-id="${itemId}"]`);
                if (listItemElement) {
                    listItemElement.querySelector('.item-title').textContent = newTitle.trim();
                }
            }
        }

        // Xóa Nội Dung
        function xoaNoiDung(listId, itemId) {
            
            let currentItem = appData[listId].items.find(item => item.id == itemId);
            if (!currentItem) return;

            if (confirm(`Bạn có chắc chắn muốn xóa nội dung "${currentItem.title}" không?`)) {
                // 1. Cập nhật dữ liệu (Xóa khỏi mảng)
                appData[listId].items = appData[listId].items.filter(item => item.id != itemId);
                saveData(); 
                
                // 2. Cập nhật giao diện DOM (Xóa phần tử <li>)
                const listItemElement = document.querySelector(`#${listId} li[data-id="${itemId}"]`);
                if (listItemElement) {
                    listItemElement.remove();
                }
            }
        }

        // === CHỨC NĂNG XUẤT/NHẬP DỮ LIỆU ===

        function xuatJSON() {
            const dataStr = JSON.stringify(appData, null, 2); 
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dynamic_data_export.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function nhapJSON(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    appData = importedData;
                    saveData();
                    renderAllListboxes();
                    alert('Nhập dữ liệu thành công!');
                } catch (error) {
                    alert('Lỗi khi đọc file JSON: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        function clearLocalStorage() {
            if (confirm('Bạn có chắc chắn muốn xóa toàn bộ dữ liệu cục bộ không? Hành động này không thể hoàn tác!')) {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                window.location.reload(); 
            }
        }

        // Gọi hàm loadData khi trang được tải xong
        window.onload = loadData; 
        
    </script>

</body>
</html>
